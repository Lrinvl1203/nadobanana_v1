<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나도바나나 이미지 생성기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .glass { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white font-sans">
    <!-- Header -->
    <header class="bg-black/30 backdrop-blur-md border-b border-white/10 p-4 sticky top-0 z-30">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold cursor-pointer" onclick="showHome()">
                🍌 나도바나나 이미지 생성기
            </h1>
            <nav class="flex gap-4 items-center">
                <button onclick="showHome()" class="hover:text-yellow-300 transition-colors">홈</button>
                <button onclick="showHistory()" class="hover:text-yellow-300 transition-colors">히스토리</button>
                <button onclick="resetApiKey()" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded transition-colors" title="API 키 재설정">
                    🔑
                </button>
            </nav>
        </div>
    </header>

    <!-- Error Display -->
    <div id="error-container" class="hidden container mx-auto p-4 sticky top-[70px] z-20">
        <div class="bg-red-500/20 border border-red-500 text-red-300 px-4 py-3 rounded relative">
            <strong class="font-bold">오류: </strong>
            <span id="error-message"></span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="hideError()">
                <svg class="fill-current h-6 w-6 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                    <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
                </svg>
            </span>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content">
        <!-- API Key Setup Screen -->
        <div id="setup-screen" class="container mx-auto p-8 max-w-2xl">
            <div class="text-center mb-8 fade-in">
                <h2 class="text-4xl font-bold mb-4 bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                    🔑 API 키 설정
                </h2>
                <p class="text-gray-300">Google Gemini API 키를 입력해주세요</p>
            </div>

            <div class="glass rounded-2xl p-6 mb-6">
                <label class="block text-sm font-medium mb-3">Gemini API Key</label>
                <input 
                    id="api-key-input"
                    type="password"
                    placeholder="Google AI Studio에서 발급받은 API 키를 입력하세요"
                    class="w-full p-4 rounded-lg bg-white/10 border border-white/20 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                >
                <div class="mt-3 text-sm text-gray-400">
                    <p>🔒 API 키는 브라우저에만 저장되며 안전합니다</p>
                    <p>📋 <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-400 hover:text-blue-300">Google AI Studio</a>에서 무료로 발급받을 수 있습니다</p>
                </div>
            </div>

            <div class="flex gap-4">
                <button 
                    onclick="saveApiKey()" 
                    disabled
                    id="save-api-key-btn"
                    class="flex-1 bg-gradient-to-r from-yellow-500 to-orange-500 text-black font-bold py-4 px-6 rounded-lg hover:from-yellow-400 hover:to-orange-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    ✅ 저장하고 시작하기
                </button>
                <button 
                    onclick="testWithoutKey()" 
                    class="bg-gray-600 hover:bg-gray-700 px-6 py-4 rounded-lg transition-colors"
                >
                    🧪 체험하기
                </button>
            </div>

            <div class="mt-6 glass rounded-xl p-4">
                <h3 class="font-bold mb-2">📖 API 키 발급 방법</h3>
                <ol class="text-sm text-gray-300 space-y-2">
                    <li>1. <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-400">Google AI Studio</a> 접속</li>
                    <li>2. "Create API key" 버튼 클릭</li>
                    <li>3. 생성된 키를 복사해서 위에 붙여넣기</li>
                    <li>4. 저장하고 시작하기!</li>
                </ol>
            </div>
        </div>

        <!-- Home Screen -->
        <div id="home-screen" class="container mx-auto p-8 max-w-2xl">
            <div class="text-center mb-8 fade-in">
                <h2 class="text-4xl font-bold mb-4 bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                    AI로 상상을 현실로
                </h2>
                <p class="text-gray-300">원하는 이미지를 설명하면 AI가 생성해드립니다</p>
            </div>

            <div class="glass rounded-2xl p-6 mb-6">
                <label class="block text-sm font-medium mb-3">이미지 생성 프롬프트</label>
                <textarea 
                    id="prompt-input"
                    placeholder="예: 노을지는 바다 위의 돛단배, 수채화 스타일"
                    class="w-full h-32 p-4 rounded-lg bg-white/10 border border-white/20 placeholder-gray-400 resize-none focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                ></textarea>
            </div>

            <div class="glass rounded-2xl p-6 mb-6">
                <label class="block text-sm font-medium mb-3">또는 기존 이미지 업로드 (수정용)</label>
                <div class="border-2 border-dashed border-white/30 rounded-lg p-6 text-center">
                    <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                    <button onclick="document.getElementById('image-upload').click()" class="text-blue-400 hover:text-blue-300">
                        📁 이미지 파일 선택하기
                    </button>
                    <p class="text-sm text-gray-400 mt-2">JPG, PNG 파일 지원</p>
                    <div id="uploaded-image-preview" class="hidden mt-4">
                        <img id="preview-img" class="max-w-full h-48 mx-auto rounded-lg">
                    </div>
                </div>
            </div>

            <button 
                onclick="generateImage()" 
                disabled
                id="generate-btn"
                class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-black font-bold py-4 px-6 rounded-lg hover:from-yellow-400 hover:to-orange-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
                ✨ 이미지 생성하기
            </button>
        </div>

        <!-- Generation Screen -->
        <div id="generation-screen" class="hidden container mx-auto p-8 max-w-2xl text-center">
            <div class="fade-in">
                <div class="loading-spinner w-16 h-16 border-4 border-yellow-500 border-t-transparent rounded-full mx-auto mb-6"></div>
                <h2 class="text-2xl font-bold mb-4">AI가 이미지를 생성하고 있습니다...</h2>
                <p class="text-gray-300">잠시만 기다려주세요. 곧 멋진 이미지가 완성됩니다!</p>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden container mx-auto p-8 max-w-4xl">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold mb-2">🎉 이미지가 생성되었습니다!</h2>
                <p id="result-prompt" class="text-gray-300"></p>
            </div>

            <div class="bg-white/10 rounded-2xl p-6 mb-6">
                <img id="result-image" class="w-full max-w-lg mx-auto rounded-lg shadow-lg">
            </div>

            <div class="flex flex-wrap gap-4 justify-center mb-6">
                <button onclick="downloadImage()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg transition-colors">
                    💾 다운로드
                </button>
                <button onclick="shareImage()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg transition-colors">
                    📤 공유하기
                </button>
                <button onclick="showEditForm()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg transition-colors">
                    ✏️ 이미지 수정
                </button>
            </div>

            <!-- Edit Form -->
            <div id="edit-form" class="hidden glass rounded-2xl p-6 mb-6">
                <label class="block text-sm font-medium mb-3">이미지 수정 프롬프트</label>
                <textarea 
                    id="edit-prompt"
                    placeholder="예: 배경을 밤하늘로 바꿔줘"
                    class="w-full h-24 p-4 rounded-lg bg-white/10 border border-white/20 placeholder-gray-400 resize-none focus:outline-none focus:ring-2 focus:ring-purple-500"
                ></textarea>
                <div class="flex gap-4 mt-4">
                    <button onclick="editCurrentImage()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg transition-colors">
                        ✨ 수정하기
                    </button>
                    <button onclick="hideEditForm()" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg transition-colors">
                        취소
                    </button>
                </div>
            </div>

            <div class="text-center">
                <button onclick="showHome()" class="bg-yellow-600 hover:bg-yellow-700 px-8 py-3 rounded-lg transition-colors">
                    🏠 새 이미지 생성하기
                </button>
            </div>
        </div>

        <!-- History Screen -->
        <div id="history-screen" class="hidden container mx-auto p-8 max-w-6xl">
            <h2 class="text-3xl font-bold text-center mb-8">📚 생성 히스토리</h2>
            <div id="history-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- History items will be inserted here -->
            </div>
            <div id="empty-history" class="hidden text-center py-12">
                <p class="text-gray-400 text-lg mb-4">아직 생성된 이미지가 없습니다</p>
                <button onclick="showHome()" class="bg-yellow-600 hover:bg-yellow-700 px-6 py-3 rounded-lg transition-colors">
                    첫 이미지 생성하기
                </button>
            </div>
        </div>
    </main>

    <script>
        // State Management
        let currentView = 'SETUP';
        let currentImage = null;
        let isLoading = false;
        let uploadedImageData = null;
        let userApiKey = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if API key is already stored
            userApiKey = localStorage.getItem('gemini-api-key');
            if (userApiKey) {
                showHome();
            } else {
                showSetup();
            }
            
            updateGenerateButton();
            loadHistory();
            
            // Add input listeners
            const promptInput = document.getElementById('prompt-input');
            if (promptInput) {
                promptInput.addEventListener('input', updateGenerateButton);
            }
            
            const apiKeyInput = document.getElementById('api-key-input');
            if (apiKeyInput) {
                apiKeyInput.addEventListener('input', updateApiKeyButton);
            }
        });

        // View Management
        function showView(viewName) {
            // Hide all screens
            document.querySelectorAll('[id$="-screen"]').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // Show selected screen
            document.getElementById(viewName + '-screen').classList.remove('hidden');
            currentView = viewName;
        }

        function showSetup() {
            showView('setup');
            clearError();
        }

        function showHome() {
            showView('home');
            clearError();
        }

        function showHistory() {
            showView('history');
            loadHistory();
        }

        function showGeneration() {
            showView('generation');
        }

        function showResult() {
            showView('result');
        }

        // Error Handling
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-container').classList.remove('hidden');
            setTimeout(hideError, 5000);
        }

        function hideError() {
            document.getElementById('error-container').classList.add('hidden');
        }

        function clearError() {
            hideError();
        }

        // Image Upload Handling
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageData = e.target.result;
                document.getElementById('preview-img').src = uploadedImageData;
                document.getElementById('uploaded-image-preview').classList.remove('hidden');
                updateGenerateButton();
            };
            reader.readAsDataURL(file);
        }

        // API Key Management
        function updateApiKeyButton() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            const btn = document.getElementById('save-api-key-btn');
            
            btn.disabled = !apiKey || apiKey.length < 10;
        }

        function saveApiKey() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            
            if (!apiKey) {
                showError('API 키를 입력해주세요.');
                return;
            }
            
            // Simple validation
            if (apiKey.length < 10) {
                showError('올바른 API 키를 입력해주세요.');
                return;
            }
            
            userApiKey = apiKey;
            localStorage.setItem('gemini-api-key', apiKey);
            showHome();
        }

        function testWithoutKey() {
            showError('체험 모드에서는 실제 이미지 생성이 불가능합니다. API 키를 입력해주세요.');
            setTimeout(() => {
                showHome();
            }, 2000);
        }

        function resetApiKey() {
            localStorage.removeItem('gemini-api-key');
            userApiKey = null;
            showSetup();
        }

        // Button State Management
        function updateGenerateButton() {
            const promptInput = document.getElementById('prompt-input');
            if (!promptInput) return;
            
            const prompt = promptInput.value.trim();
            const hasUpload = !!uploadedImageData;
            const btn = document.getElementById('generate-btn');
            
            if (hasUpload && prompt) {
                btn.disabled = false;
                btn.textContent = '✨ 이미지 수정하기';
            } else if (!hasUpload && prompt) {
                btn.disabled = false;
                btn.textContent = '✨ 이미지 생성하기';
            } else {
                btn.disabled = true;
                btn.textContent = '✨ 이미지 생성하기';
            }
        }

        // API Calls to Netlify Functions
        async function generateImage() {
            const prompt = document.getElementById('prompt-input').value.trim();
            
            if (!prompt) {
                showError('프롬프트를 입력해주세요.');
                return;
            }

            if (!userApiKey) {
                showError('API 키가 설정되지 않았습니다. 오른쪽 상단 🔑 버튼을 클릭해서 설정해주세요.');
                return;
            }

            isLoading = true;
            showGeneration();
            clearError();

            try {
                const isEdit = !!uploadedImageData;
                const endpoint = isEdit ? '/.netlify/functions/edit-image' : '/.netlify/functions/generate-image';
                
                const requestBody = {
                    prompt: prompt,
                    apiKey: userApiKey,
                    ...(isEdit && { imageData: uploadedImageData })
                };

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`API 오류: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Save to history
                const imageRecord = {
                    id: Date.now().toString(),
                    src: data.imageUrl,
                    prompt: isEdit ? `(수정됨) ${prompt}` : prompt,
                    timestamp: Date.now()
                };
                
                addToHistory(imageRecord);
                displayResult(imageRecord);
                
                // Clear inputs
                document.getElementById('prompt-input').value = '';
                uploadedImageData = null;
                document.getElementById('uploaded-image-preview').classList.add('hidden');
                updateGenerateButton();

            } catch (error) {
                console.error('Generation error:', error);
                showError(error.message || '이미지 생성 중 오류가 발생했습니다.');
                showHome();
            } finally {
                isLoading = false;
            }
        }

        // Result Display
        function displayResult(imageRecord) {
            currentImage = imageRecord;
            document.getElementById('result-image').src = imageRecord.src;
            document.getElementById('result-prompt').textContent = `"${imageRecord.prompt}"`;
            showResult();
        }

        // Edit Functionality
        function showEditForm() {
            document.getElementById('edit-form').classList.remove('hidden');
        }

        function hideEditForm() {
            document.getElementById('edit-form').classList.add('hidden');
            document.getElementById('edit-prompt').value = '';
        }

        async function editCurrentImage() {
            const editPrompt = document.getElementById('edit-prompt').value.trim();
            
            if (!editPrompt) {
                showError('수정 프롬프트를 입력해주세요.');
                return;
            }

            if (!currentImage) {
                showError('수정할 이미지가 없습니다.');
                return;
            }

            isLoading = true;
            showGeneration();
            hideEditForm();

            try {
                const response = await fetch('/.netlify/functions/edit-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imageData: currentImage.src,
                        prompt: editPrompt,
                        apiKey: userApiKey
                    })
                });

                if (!response.ok) {
                    throw new Error(`API 오류: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                const newImageRecord = {
                    id: Date.now().toString(),
                    src: data.imageUrl,
                    prompt: `${currentImage.prompt} (수정: ${editPrompt})`,
                    timestamp: Date.now()
                };
                
                addToHistory(newImageRecord);
                displayResult(newImageRecord);

            } catch (error) {
                console.error('Edit error:', error);
                showError(error.message || '이미지 수정 중 오류가 발생했습니다.');
                showResult();
            } finally {
                isLoading = false;
            }
        }

        // History Management
        function getHistory() {
            const history = localStorage.getItem('nadobanana-history');
            return history ? JSON.parse(history) : [];
        }

        function addToHistory(imageRecord) {
            const history = getHistory();
            history.unshift(imageRecord);
            // Keep only last 50 images
            if (history.length > 50) {
                history.splice(50);
            }
            localStorage.setItem('nadobanana-history', JSON.stringify(history));
        }

        function loadHistory() {
            const history = getHistory();
            const grid = document.getElementById('history-grid');
            const emptyState = document.getElementById('empty-history');
            
            if (history.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            grid.innerHTML = history.map(item => `
                <div class="glass rounded-xl p-4 cursor-pointer hover:bg-white/20 transition-all" onclick="selectHistoryImage('${item.id}')">
                    <img src="${item.src}" alt="${item.prompt}" class="w-full h-48 object-cover rounded-lg mb-3">
                    <p class="text-sm text-gray-300 line-clamp-2">${item.prompt}</p>
                    <p class="text-xs text-gray-500 mt-2">${new Date(item.timestamp).toLocaleDateString('ko-KR')}</p>
                </div>
            `).join('');
        }

        function selectHistoryImage(imageId) {
            const history = getHistory();
            const image = history.find(item => item.id === imageId);
            if (image) {
                displayResult(image);
            }
        }

        // Utility Functions
        function downloadImage() {
            if (!currentImage) return;
            
            const link = document.createElement('a');
            link.href = currentImage.src;
            link.download = `nadobanana-${currentImage.id}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function shareImage() {
            if (!currentImage) return;

            if (navigator.share) {
                try {
                    // Convert base64 to blob for sharing
                    const response = await fetch(currentImage.src);
                    const blob = await response.blob();
                    const file = new File([blob], `nadobanana-${currentImage.id}.png`, { type: 'image/png' });
                    
                    await navigator.share({
                        title: '나도바나나에서 생성한 이미지',
                        text: currentImage.prompt,
                        files: [file]
                    });
                } catch (error) {
                    fallbackShare();
                }
            } else {
                fallbackShare();
            }
        }

        function fallbackShare() {
            // Fallback: copy link to clipboard
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                showError('링크가 클립보드에 복사되었습니다!');
            });
        }

        // Initialize
        showHome();
    </script>
</body>
</html>